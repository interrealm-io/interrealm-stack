# Capability Definition Schema
# Version: 2.0.0

$schema: "http://json-schema.org/draft-07/schema#"
title: "Capability Definition"
description: "Schema for defining capabilities in RealmMesh"

type: object
properties:
  name:
    type: string
    description: "Unique capability name"
    pattern: "^[a-z][a-z0-9-]*$"

  version:
    type: string
    description: "Semantic version"
    pattern: "^\\d+\\.\\d+\\.\\d+$"

  description:
    type: string
    description: "Human-readable description"

  author:
    type: string
    description: "Capability author"

  stability:
    type: string
    enum: [experimental, beta, stable, deprecated]
    default: stable

  documentation:
    type: string
    format: uri
    description: "Link to documentation"

  services:
    type: array
    description: "Service definitions"
    items:
      $ref: "#/definitions/Service"

  events:
    type: array
    description: "Event definitions"
    items:
      $ref: "#/definitions/Event"

  loops:
    type: array
    description: "Loop definitions"
    items:
      $ref: "#/definitions/Loop"

  loopStacks:
    type: array
    description: "Loop stack definitions"
    items:
      $ref: "#/definitions/LoopStack"

required:
  - name
  - version

definitions:
  Service:
    type: object
    properties:
      name:
        type: string
      description:
        type: string
      input:
        type: object
        description: "JSON Schema for input"
      output:
        type: object
        description: "JSON Schema for output"
      errors:
        type: array
        items:
          type: string
    required:
      - name

  Event:
    type: object
    properties:
      name:
        type: string
      description:
        type: string
      payload:
        type: object
        description: "JSON Schema for event payload"
    required:
      - name

  Loop:
    type: object
    properties:
      name:
        type: string
      description:
        type: string
      input:
        type: object
      output:
        type: object
      minParticipants:
        type: integer
        minimum: 1
      maxParticipants:
        type: integer
      recruitmentTimeout:
        type: integer
        description: "Timeout in milliseconds"
      executionTimeout:
        type: integer
        description: "Timeout in milliseconds"
    required:
      - name

  LoopStack:
    type: object
    properties:
      name:
        type: string
      description:
        type: string
      loops:
        type: array
        items:
          type: string
        description: "Ordered list of loop names"
      aggregationStrategy:
        type: string
        enum: [sequential, parallel, first-success, all-success]
    required:
      - name
      - loops
